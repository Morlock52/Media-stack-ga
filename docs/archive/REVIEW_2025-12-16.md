# Media Stack Program Review (2025-12-16)

This review reads the project twice:

1) **As an end user** (setup + day-1 operations experience).
2) **As an engineer** (architecture, correctness, security, maintainability).

It also includes quick validation runs:

- `npm -w docs-site run build` ✅
- `npm -w docs-site run lint` ✅
- `npm -w control-server run build` ✅
- `npm -w control-server run lint` ✅ (1 warning)
- `npm -w control-server test` ❌ (Vitest/esbuild service crash under Node `v24.6.0`)
- `npm audit --omit=dev` ❌ (3 moderate vulns via `react-syntax-highlighter` → `refractor` → `prismjs`)

---

## End‑User Review (what a non‑expert experiences)

### What works well

- Clear “stack at a glance” story and strong security framing in `README.md`.
- Multiple onboarding options: interactive shell setup (`setup.sh`), a modern web wizard (`docs-site`), and a Dockerized wizard (`docker-compose.wizard.yml`).
- The web wizard UX is polished: guided steps, storage planner, “Download All Files”, and a post‑install checklist.

### Primary user friction / confusion points

- **Multiple “sources of truth” drift**: the root `docker-compose.yml`, the web wizard’s generated compose (`docs-site/src/utils/dockerComposeGenerator.ts`), and the TUI scripts (`setup.sh`, `setup.ps1`, `setup_auto.sh`) do not align in important details (VPN isolation, port exposure, variable naming).

- **Setup path mismatch**: `README_DOCKER.md`/`QUICK_REFERENCE.md` references differ from `docker-compose.wizard.yml` port mapping (UI is exposed on a different port).

- **Template configs ship with real-looking values** (domains/passwords) inside `config/` templates, which can mislead users into deploying insecure defaults.

- **Too many entry points without a “pick one” guide**: users may not know whether to start with `setup.sh`, the web wizard, or manual `.env` + `docker compose up`.

### Day‑2 operations (once it's running)

- The repo includes helpful operator scripts (`scripts/doctor.sh`, `scripts/update.sh`, `rotate_secrets.sh`), but command detection is inconsistent across them (`docker compose` vs `docker-compose`) and some scripts hard-code assumptions that won’t fit macOS/Windows or custom data roots.

---

## Engineer Review (correctness, security, maintainability)

### Architecture snapshot

- Monorepo (`package.json` workspaces):
  - `docs-site` (Vite + React UI wizard + docs)
  - `control-server` (Fastify API that can talk to Docker, handle AI chat/voice, and perform remote deploy)

### High‑risk security findings (P0)

- `control-server` listens on `0.0.0.0` and enables `cors: { origin: '*' }` (`control-server/src/index.ts`, `control-server/src/app.ts`).
  - Combined with endpoints that can run Docker commands and edit `.env`, this is **dangerous** if the service becomes reachable beyond localhost (e.g., remote server, shared LAN, misconfigured firewall, or tunnel).
- Secrets handling is inconsistent:
  - `.env` key naming drift across scripts vs compose vs wizard.
  - Template configs contain hard-coded secrets (example: Authelia Redis password in `config/authelia/configuration.yml`).
  - The web wizard stores configuration via Zustand persistence (likely localStorage), which risks persisting API keys on shared machines.

### Correctness / consistency issues (P0/P1)

- Compose/profile logic differs across:
  - Root `docker-compose.yml` (qbittorrent `network_mode: service:gluetun`)
  - Wizard generator (`docs-site/src/utils/dockerComposeGenerator.ts`) (qbittorrent is **not** actually routed through Gluetun; plus a Plex transcode mount appears in the `environment` list by mistake).
- Script drift:
  - `setup.sh` detects the correct compose command but later still runs `docker-compose` directly.
  - `rotate_secrets.sh` edits secret keys that don’t match `.env.example`.
- `control-server` registry path looks wrong for this repo layout (`control-server/src/routes/registry.ts`), likely causing the registry endpoints to silently do nothing.

### Quality signals

- Lint/build are passing for both workspaces.
- Automated tests exist, but `control-server`’s Vitest run fails under Node 24, suggesting tooling/version skew.

---

## 25 Improvements (picked to satisfy both end users + engineers)

Each item includes: **Impact** (user+engineering), **Priority**, and a suggested **Approach**.

1. **Choose one “source of truth” for service definitions**
       - Impact: users get consistent outputs; engineers stop chasing drift.
       - Priority: P0
       - Approach: generate `docker-compose.yml` from a single canonical definition (or make the wizard import the real compose and only edit variables/profiles).

1. **Fix `.env` key naming drift for Authelia secrets**
       - Impact: fewer “it doesn’t work” setups; less hidden coupling.
       - Priority: P0
       - Approach: align `setup.sh`, `setup.ps1`, `setup_auto.sh`, `rotate_secrets.sh`, and `.env.example` to one naming scheme (and update compose + docs accordingly).

1. **Fix VPN isolation mismatch in the wizard compose generator**
       - Impact: prevents accidental IP leaks; reduces support burden.
       - Priority: P0
       - Approach: make torrent traffic actually route via Gluetun (e.g., `network_mode: service:gluetun` and matching port mapping strategy).

1. **Stop shipping real domains/passwords in template config files**
        - Impact: users don’t accidentally deploy unsafe defaults; reduces reputational risk.
        - Priority: P0
        - Approach: replace with placeholders and generate final configs during wizard export or setup scripts.

1. **Lock down `control-server` by default**
       - Impact: prevents remote abuse; makes production deployments safer.
       - Priority: P0
       - Approach: bind to `127.0.0.1` by default; require an auth token for all non-health endpoints; restrict CORS origins.

1. **Add a minimal auth layer for Docker‑control endpoints**
       - Impact: safer remote use; clear security posture.
       - Priority: P0
       - Approach: bearer token (env var) + optional IP allowlist; document how to expose safely behind a proxy.

1. **Remove direct OpenAI calls from the browser (or make it an explicit “unsafe mode”)**
       - Impact: users don’t leak API keys; engineers centralize rate limits + logging.
       - Priority: P0
       - Approach: proxy AI requests through `control-server` so the UI never needs the raw key.

1. **Do not persist OpenAI API keys in localStorage**
       - Impact: protects users on shared machines; reduces accidental leaks.
       - Priority: P0
       - Approach: store server-side (encrypted at rest) or keep in memory/session only; add “clear key” UI.

1. **Make `setup.sh` consistently use the detected compose command**
       - Impact: fewer environment-specific failures; simpler support.
       - Priority: P1
       - Approach: replace `docker-compose ...` usages with `${COMPOSE_CMD} ...`.

1. **Fix the Dockerized wizard port mismatch in docs**
        - Impact: users can actually find the UI; fewer "it's broken" reports.
        - Priority: P1
        - Approach: reconcile `README_DOCKER.md` and `QUICK_REFERENCE.md` with `docker-compose.wizard.yml` (or change the compose mapping).

1. **Fix `control-server` registry pathing**
       - Impact: features work; engineers avoid path bugs across environments.
       - Priority: P1
       - Approach: compute repo root robustly, or pass `DOCS_SITE_ROOT` as an env var; avoid hard-coded repo names.

1. **Make `.env` edits preserve comments/formatting**
       - Impact: users keep readable config; engineers avoid rewriting footguns.
       - Priority: P1
       - Approach: use a dotenv parser that round-trips comments, or store settings in a separate machine-managed file.

1. **Switch the wizard YAML generator to a real YAML serializer**
       - Impact: fewer invalid outputs; faster iteration.
       - Priority: P1
       - Approach: use a maintained YAML library and add a "validate with `docker compose config`" step before download.

1. **Unify port exposure policy (and document it)**
       - Impact: users don’t accidentally expose admin UIs; engineers keep sane defaults.
       - Priority: P1
       - Approach: default to `expose` for internal UIs; if ports are needed, bind to `127.0.0.1:` and document firewall expectations.

1. **Pin Docker images (or provide an explicit “latest” vs “pinned” mode)**
       - Impact: fewer surprise breakages; reproducible installs.
       - Priority: P1
       - Approach: version tags (or digests) + a controlled update process; make Watchtower opt-in.

1. **Make Watchtower/Autoheal opt‑in profiles**
       - Impact: fewer “why did it update?” incidents; cleaner production posture.
       - Priority: P2
       - Approach: move them behind a profile like `ops`.

1. **Fix Plex token vs Plex claim confusion in generated `.env`**
       - Impact: users configure correctly; fewer broken widgets.
       - Priority: P1
       - Approach: separate fields for `PLEX_CLAIM` (one-time) vs `PLEX_TOKEN` (server token); adjust wizard labels.

1. **Add an explicit “Local‑only / No Cloudflare” onboarding path**
       - Impact: reduces cognitive load; increases adoption.
       - Priority: P2
       - Approach: wizard mode that generates a LAN-only stack (no tunnel) and clearly explains tradeoffs.

1. **Make “doctor” checks cross‑platform**
       - Impact: fewer failures on macOS/Windows; more trust.
       - Priority: P2
       - Approach: detect `lsof`/`netstat` availability; fall back gracefully; improve messaging.

1. **Harden the remote deploy flow**
       - Impact: safer deployments; clearer errors.
       - Priority: P2
       - Approach: make host-key checking configurable, validate dependencies (`ssh`, `scp`, `sshpass`), and add timeouts.

1. **Expand CI beyond compose validation**
       - Impact: catches regressions early; boosts contributor confidence.
       - Priority: P2
       - Approach: run `npm -w docs-site lint/build`, `npm -w control-server lint/build`, and unit tests; optionally `npm audit` on main.

1. **Fix `control-server` tests under Node 24**
       - Impact: reliable CI; faster engineering iteration.
       - Priority: P2
       - Approach: upgrade Vitest (and any pinned esbuild/vite peer deps) to versions that support Node 24.

1. **Address `npm audit` findings in syntax highlighting dependencies**
       - Impact: reduces known vulns; improves security story.
       - Priority: P2
       - Approach: update/replace `react-syntax-highlighter` (or switch to a different highlighter) to pull `prismjs >= 1.30.0`.

1. **Add “generated files” provenance + versioning**
       - Impact: users can re-run safely; engineers can migrate formats.
       - Priority: P2
       - Approach: embed `generated_by`, `version`, and timestamps in output; provide migration notes when templates change.

1. **Write a single “Start Here” decision guide**
       - Impact: dramatically smoother onboarding; fewer support requests.
       - Priority: P1
       - Approach: a short doc that routes users to (A) web wizard, (B) setup.sh, or (C) manual compose, with pros/cons.

---

## 2025-12-17 Implementation Log (AI/Voice)

- Centralized OpenAI calls in `control-server` (removed browser-direct calls):
  - `docs-site/src/components/AIGuide.tsx` now uses `/api/agent/chat`
  - `docs-site/src/utils/aiHelper.ts` now uses `/api/ai/service-config`
  - Added `/api/ai/service-config` endpoint in `control-server`
- Hardened agent tooling surface:
  - Removed generic `run_command` tool exposure; kept only purpose-built tools (`analyze_logs`, `validate_config`).
- Added high-quality TTS endpoint in `control-server`:
  - `POST /api/tts` with model/voice/format support and fallback model.
- Reduced error/bloat and improved resilience:
  - Standardized OpenAI upstream error responses (`401 invalid_api_key`, `429 rate_limited`, `502 upstream_error`) and avoided dumping upstream bodies.
  - `docs-site` now falls back gracefully when key is missing/invalid:
    - `VoiceCompanion` auto-falls back to browser TTS and shows a short hint.
    - `AIGuide` chat works without a key (server fallback) and shows compact auth/rate messages.
    - `AI Suggest` shows compact auth/rate messages.

### Tests run

- `docs-site`: `npm run lint`, `npm run build` ✅
- `control-server`: `npm run lint`, `npm run build` ✅
- Runtime smoke (control-server on `127.0.0.1:3001`):
  - `GET /api/health` ✅
  - Invalid-key checks return compact `401 invalid_api_key` for `/api/tts`, `/api/ai/service-config`, `/api/agent/chat` ✅
