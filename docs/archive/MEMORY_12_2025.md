## Media Stack GA — Memory & Changes (12/2025)

This file tracks the December 2025 stabilization work focused on the Wizard UI, control-server integration, remote deploy reliability, and voice output quality options.

### What was broken / confusing

- Wizard forms could fail validation because React Hook Form `ref` registration was being overwritten in custom inputs.
- Tdarr-only stacks did not show Movies/TV storage categories because the storage plan referenced `tdarr` instead of the wizard’s `transcode` profile.
- Remote Deploy in the UI was hard-blocked unless `VITE_CONTROL_SERVER_URL` was set, even when `/api` was correctly proxied (Vite dev proxy or dockerized nginx proxy).
- Remote Deploy errors were often not actionable (e.g. token required, proxy missing, ssh tools missing).
- Some UI overlay layers could intercept clicks (pointer-events), making inputs/buttons feel “broken”.

### Changes made

#### Wizard UI

- Fixed RHF registration so Domain/Password/Combobox values persist and validate correctly.
- Fixed storage planner categories for Tdarr/transcode stacks.
- Prevented click interception from decorative overlay layers in `InteractiveCard`.

#### Control-server connectivity (docs-site)

- Added browser-stored overrides for:
  - Control server base URL (when UI is hosted separately)
  - Control server bearer token (when `CONTROL_SERVER_TOKEN` is enabled)
- Improved Remote Deploy error output by including response bodies and a clear “token required” hint.
- Prefetched the Remote Deploy modal chunk when the Deploy button becomes available to avoid cold-load flakiness (notably in Playwright screenshot runs).
- Added a visible “Loading remote deploy…” overlay while the modal lazy-chunk loads, and prefetch-on-hover/focus to make the Deploy button feel responsive even on slow devices.

#### Remote deploy (control-server)

- Added SSH client hardening defaults: `ConnectTimeout`, `ConnectionAttempts`, and keepalives.
- Improved “missing binary” detection (e.g. `sshpass`/`ssh`/`scp` missing) to return clear installation guidance.
- Made `/api/remote-deploy/test` perform an actual SSH connection check first, so “Docker not found” doesn’t mask connection failures.

#### Voice output

- Added optional ElevenLabs TTS support on the control server (`/api/tts` now supports `provider: "openai" | "elevenlabs"`).
- Added ElevenLabs settings endpoints:
  - `POST/DELETE /api/settings/elevenlabs-key`
  - `POST /api/settings/elevenlabs-voice`
  - `GET /api/settings/tts` (provider/key availability + defaults)
- Updated Voice Companion to allow “ElevenLabs (HQ)” output when configured (otherwise it falls back to OpenAI or browser TTS).

### Config notes

- Docker Wizard mode already proxies `/api` to the control server via `docs-site/nginx.conf`, so `VITE_CONTROL_SERVER_URL` is not required in that mode.
- Static-hosted UI (Netlify/etc) still needs a reachable control server URL and valid CORS configuration; use the Settings page “Control Server Connection” overrides.
- If you start the control server with `CONTROL_SERVER_TOKEN`, the browser must send `Authorization: Bearer <token>` for all `/api/*` routes (except `/api/health`).

### Verification

- `npm run lint`
- `npm test` (control-server vitest + docs-site Playwright smoke)
- `UI_REVIEW=1 npx playwright test docs-site/tests/ui-review.screenshots.spec.ts -c docs-site/playwright.config.ts`
