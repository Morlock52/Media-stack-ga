# Media Stack — Full Repo Review (2025-12-18)

This is a repo-wide review of **code + scripts + Docker + docs** with a focus on:
- correctness / drift between “sources of truth”
- security posture (secrets, exposure, defaults)
- tech bloat (dead code, unused deps, duplicated docs)
- a concrete architecture + framework + GUI plan to make this the best app possible

## Reality check (date + limitations)

- I reviewed the repo state on **2025-12-18** (your request: “as of 12/17/25”).  
- My model knowledge cutoff is **2025-08**; I can still evaluate *this repo* precisely and recommend best practices that remain valid, but I cannot guarantee “what’s best” changed after that date unless you want a dedicated web-research pass.
- I did use the internet during this run to pull tooling via `npx` (e.g., `knip`, `depcheck`) and to validate that the codebase builds/tests cleanly.

## What I actually validated (local runs)

### JS/TS validation
- `npm audit` ✅ (0 vulnerabilities)
- `npm -w docs-site run lint` ✅
- `npm -w docs-site run build` ✅ (bundle size warning; see Performance)
- `npm -w docs-site test` ✅ (7 Playwright smoke tests)
- `npm -w control-server run lint` ✅ (1 warning)
- `npm -w control-server run build` ✅
- `npm -w control-server test` ✅ (16 tests)

### Bloat scanners (automated)
- `npx depcheck docs-site` (found unused deps; see Tech bloat)
- `npx depcheck control-server` (found transitive-dep usage; see Tech bloat)
- `npx knip --directory docs-site` (found ~50 unused files + unused deps/exports)
- `npx knip --directory control-server` (found transitive deps + unused files/exports)

## Plan execution (changes applied on 2025-12-18)

These are the concrete changes I applied to the repo while “executing the plan”:

- **Stopped committing secrets/junk**: removed tracked `./.env`, `control-server/.env`, and `./.DS_Store` from git; removed tracked `control-server/dist/**` build artifacts.
- **Removed lockfile sprawl**: removed `bun.lock` files and `control-server/package-lock.json` (kept the root `package-lock.json` as the workspace lock).
- **Pruned dead UI**: deleted the unused `docs-site/src/utils/dockerComposeGenerator.ts` and removed ~50 unused UI/utility files reported by `knip`.
- **Removed unused deps**: removed unused `docs-site` deps (`@tanstack/react-query`, `@use-gesture/react`, `react-markdown`, `react-syntax-highlighter`, and related types).
- **Fixed transitive dependency reliance**: added explicit `pino` dependency to `control-server` and removed an unused `pino` import.
- **Hardened defaults**:
  - removed the hard-coded default master password from `setup.sh` / `setup.ps1` (now requires a non-empty password)
  - removed `adminadmin` defaults and updated guides to match LinuxServer qBittorrent’s first-run password behavior
  - replaced Homepage qBittorrent widget credentials with env vars (`QBITTORRENT_WIDGET_USERNAME`, `QBITTORRENT_WIDGET_PASSWORD`)
- **Standardized Compose usage**: scripts now prefer `docker compose` with fallback to `docker-compose` where appropriate (notably `setup.ps1`, `setup_auto.sh`, `scripts/analyze_logs.py`, plus doc touch-ups).
- **Reduced shipped JS**: changed lucide icon mapping to direct imports (tree-shaking friendly).

### Measured impact (bundle size)

After pruning + fixing icon imports, the `docs-site` production build changed from:
- `ui-*.js` ~981KB → **~151KB** (minified), based on `npm -w docs-site run build` output.

## Executive summary (the 6 biggest problems)

1) **Secrets & local config are in git**  
   - `./.env` and `./control-server/.env` are tracked (`git ls-files` shows both).  
   - This is a **P0** issue: assume secrets are compromised if this repo was ever pushed.

   ✅ **Addressed in this run** (files removed from git).  
   Still required: rotate any real secrets and consider history rewrite if the repo was ever published.

2) **UI/codebase has major dead-code bloat**  
   - `knip` reports **~50 unused files** in `docs-site/src` (many big TSX components + an entire unused compose generator).  
   - This bloat increases maintenance cost, bundle size, and contributor confusion.

3) **Dependency hygiene issues (transitive deps, unused deps)**  
   - `control-server` imports/uses `pino` (`control-server/src/utils/docker.ts`, `control-server/src/app.ts`) but does not declare it in `control-server/package.json` (relying on transitive deps via Fastify).  
   - `docs-site` includes unused deps like `@tanstack/react-query`, `@use-gesture/react`, and (per `knip`) `react-markdown` + `react-syntax-highlighter`.

4) **Docs drift / contradictions across markdown files**  
   - `bloat.md` claims React 19 migration is complete, but current `docs-site/package.json` is React **18.3.x**.  
   - `IMPROVEMENT_PLAN_GA.md` repeatedly references **Authentik/Traefik**, while the actual stack is **Authelia + (labels / reverse proxy assumed)**.

5) **Performance: the UI ships too much JS**  
   - `docs-site` build output shows a very large UI chunk (`docs-site` build: `ui-*.js` ~981KB minified).  
   - The largest likely contributor is `docs-site/src/components/docs/appData.ts` using `import * as Icons from 'lucide-react'` (can defeat tree-shaking).

6) **Security defaults are “too real” and appear in multiple places**  
   - The default password string `Morlock52$` appears in docs and scripts (e.g., `setup.sh`, `setup.ps1`, and even an unused UI component `docs-site/src/components/modern/StackBuilder.tsx`).  
   - Root `docker-compose.yml` also includes default-looking credentials in Homepage widget labels for qBittorrent.

## P0/P1 Findings (with concrete file pointers)

### P0 — secrets committed to git
- `./.env` (tracked)  
- `./control-server/.env` (tracked)

**Impact**: if this repo ever touched GitHub, assume those secrets leaked. Even if “placeholders”, many users will copy/paste and accidentally deploy insecurely.

**Fix path**:
- Remove both from git history (not only from the working tree) and rotate any real secrets.
- Keep only `.env.example` tracked.

### P0 — “source of truth” is improving, but old generator code is still present
Good news: the wizard downloads the real compose as raw text:
- `docs-site/src/components/SetupWizard.tsx` imports `../../../docker-compose.yml?raw`

But an unused compose generator still exists:
- `docs-site/src/utils/dockerComposeGenerator.ts` (unused per `knip` and no references via `rg`)

**Impact**: readers will assume the generator is authoritative and waste time debugging “drift” that isn’t active anymore.

### P1 — `control-server` relies on transitive dependencies
- Uses `pino` in `control-server/src/utils/docker.ts`, but `control-server/package.json` does not list `pino`.
- `control-server/src/app.ts` imports `pino` but does not use it (dead import; also triggers `knip` “unlisted dependency” findings).

**Impact**: installs can break depending on hoisting rules; future upgrades can silently break your server.

### P1 — script command drift (`docker compose` vs `docker-compose`)
Examples:
- `scripts/analyze_logs.py` shells out to `docker-compose` directly.
- `setup_auto.sh` instructs users to run `docker-compose up -d`.

**Impact**: on many modern Docker installs, `docker-compose` is missing (Compose v2 is `docker compose`).

### P1 — docs-site bundle bloat likely caused by icon import style
- `docs-site/src/components/docs/appData.ts` does `import * as Icons from 'lucide-react'`.

**Impact**: this can pull more of the icon library than needed. You already saw a large `ui` chunk in production build.

### P1 — control-server surface area is “dangerous by design”
The control server can:
- run docker commands (`control-server/src/routes/docker.ts`, `control-server/src/utils/docker.ts`)
- read/write `.env` (`control-server/src/utils/env.ts`, `control-server/src/routes/ai.ts`)
- remote deploy over SSH (`control-server/src/routes/remote.ts`)

This is OK for a **local-only control plane**, but becomes a serious risk if exposed beyond localhost (or deployed with Cloudflare tunnel behind it).

## Tech bloat report (what to remove or consolidate)

### docs-site: unused deps (confirmed by `depcheck` + `knip`)
- Unused deps: `@tanstack/react-query`, `@use-gesture/react`, `react-markdown`, `react-syntax-highlighter`
- Unused dev deps: `@types/react-syntax-highlighter` (follows the above)

If you are not rendering Markdown in the UI anymore (you’re using TSX guides), you can remove Markdown+syntax-highlighting entirely and reduce bundle + risk.

### docs-site: unused files (50 reported by `knip`)
Examples of likely-dead areas (not imported anywhere):
- many “marketing” components in `docs-site/src/components/*` (case studies, comparisons, dashboards, etc.)
- multiple “modern” components that look like earlier UI experiments
- `docs-site/src/utils/dockerComposeGenerator.ts` (compose generator)  
- `docs-site/src/lib/content.ts` (raw imports of README/QUICK_REFERENCE)

**Recommendation**: move experiments into a separate folder (`docs-site/src/experiments/`) or delete them in a cleanup PR, so the production codebase matches what users actually see.

### control-server: unused deps / missing deps
- Remove unused: `supertest`, `@types/supertest` (no references in tests)
- Add explicit dependency: `pino` (or remove pino usage and use Fastify logger everywhere)

### repo-wide: non-source files tracked or present
- `./.DS_Store` is tracked (should be removed from git).
- Multiple lockfiles (`package-lock.json` + `bun.lock` in multiple places): pick one package manager and delete the rest.

## Documentation quality issues (what’s wrong and how to fix it)

### “Doc sprawl” + contradictions
Tracked docs include 25+ markdown files at the repo root (plus docs-site docs). Many contain overlapping plans and older decisions.

Specific contradictions:
- `bloat.md` claims “React 19 complete”, but runtime deps are React 18.
- `IMPROVEMENT_PLAN_GA.md` references Authentik/Traefik while the stack is Authelia + Cloudflare tunnel.

**Recommendation**:
- Create a single `docs/` (or `docs-site/content/`) “Start Here” that points to:
  - Web wizard flow
  - CLI/TUI flow
  - Manual compose flow
- Move older plans into `docs/archive/` and label them as historical.

## Performance & UX improvements (high leverage)

### 1) Fix icon import (likely immediate win)
In `docs-site/src/components/docs/appData.ts`, replace:
```ts
import * as Icons from 'lucide-react'
```
with direct imports:
```ts
import { Film, Tv, Activity, Search, Download, Shield, Home } from 'lucide-react'
```

This makes tree-shaking straightforward and often reduces the shipped chunk significantly.

### 2) Code-split routes and heavy features
Right now everything is eagerly imported (wizard + docs + assistant UI).

Recommend:
- Route-level lazy loading (`react-router-dom` supports `lazy()` + `Suspense`)
- Lazy-load AI/voice UI (only when users open it)

### 3) Reduce “UI surface area” to what ships
If a component is not reachable from routes, delete it or move it to an experiments folder.

## Security model upgrades (make it safe by default)

### P0: stop persisting API keys in the browser
- `docs-site/src/store/setupStore.ts` uses `persist(...)` and includes `openaiApiKey`.

**Recommendation**:
- Don’t persist `openaiApiKey` (or store it only in memory/sessionStorage with explicit user consent).
- Prefer server-side OpenAI calls via `control-server` with:
  - short-lived session token
  - per-IP rate limits
  - request logging with redaction

### P0: remove default credentials from templates
Examples that should never ship “real” defaults:
- `setup.sh` / `setup.ps1` default master password
- Homepage widget labels in `docker-compose.yml` for qBittorrent

### P1: harden the control server if it ever binds to `0.0.0.0`
Baseline recommendations (practical and common on GitHub projects doing “local control planes”):
- Require `CONTROL_SERVER_TOKEN` if `CONTROL_SERVER_HOST` is not `127.0.0.1`
- Add `@fastify/rate-limit` on AI endpoints and any “docker exec” style endpoint
- Add an allowlist for docker-compose actions (you’ve already avoided a generic `run_command`, which is good)
- Ensure logs do not print secrets (your docker runner logs args; add redaction)

## “Best possible app” architecture plan (frameworks + GUI + roadmap)

### Target product definition
Make “Media Stack” one cohesive product with three clear interfaces:
1) **Web Wizard (GUI)**: generate configs safely and explain choices.
2) **Control Plane (local API)**: read stack status, run safe operations, remote deploy (optional).
3) **Docs (content)**: versioned, searchable, consistent with the generator.

### Recommended framework choices (minimize churn, maximize value)

**Frontend (docs-site)**
- Keep: **Vite + React + TypeScript** (already works, fast iteration).
- UI: keep Radix + Tailwind + your existing button/dialog primitives.
- State: keep Zustand for wizard state (simple), add TanStack Query *only if* you actually have complex server state (otherwise it’s just extra surface area).

**Backend (control-server)**
- Keep: **Fastify + TypeScript** (good for a local control-plane).
- Add: OpenAPI + runtime validation for all request bodies (Zod or JSON schema).
- Add: authentication required when reachable beyond localhost.

**Docs**
Choose one of these (pick based on your goals):
- Option A (least churn): keep TSX guides, but generate them from a registry to avoid manual duplication.
- Option B (best long-term docs UX): move guides to **MDX** (or a docs framework like Astro Starlight/Docusaurus) and render them consistently with a single layout.

### The “single source of truth” you need (core architectural change)
Create one canonical registry that drives everything:

**`packages/registry` (new workspace package)**
- `services.ts`: IDs, images, profiles, ports, volumes, env var schema, security notes
- `docs.ts`: pointers to docs content (mdx/tsx)
- `ui.ts`: card metadata (name, icon, categories)

Then generate:
- `docker-compose.yml` (or import it as a template but validate against registry)
- `.env.example` + wizard `.env` output
- docs index + navigation

### Roadmap (sequenced to minimize risk)

#### Phase 0 (today): safety + hygiene (P0)
- Remove tracked `.env` files and rotate secrets
- Remove `.DS_Store` from git
- Pick one package manager (recommend `npm` or `pnpm` for workspaces; delete `bun.lock` if not using Bun)

#### Phase 1 (1–3 days): bloat purge + bundle reduction (P1)
- Fix lucide icon import style
- Delete/move unused files per `knip` results
- Remove unused deps per `depcheck`/`knip`
- Add route-level code splitting

#### Phase 2 (1–2 weeks): registry-driven generation (P0/P1)
- Add `packages/registry`
- Generate `.env.example` and validate wizard output
- Add “compose validation” in CI: `docker compose config` + schema checks

#### Phase 3 (2–4 weeks): hardened control-plane + real “app management”
- Tighten auth/rate limits for control-server
- Make GitHub scraping safe (URL parsing + host allowlist + optional token + caching)
- Background jobs for slow operations (remote deploy, AI doc generation)

#### Phase 4 (ongoing): docs system overhaul + community readiness
- Move docs to MDX or a docs framework
- Add contributor guide, “Start Here”, and consistent naming/versioning
- Add a minimal telemetry-free error reporting path (copyable debug bundle)

## External “best practice” references worth aligning to (GitHub / community)

These are consistently strong sources for media-stack conventions and hard-earned defaults:
- TRaSH Guides (Sonarr/Radarr quality profiles and naming)
- Servarr (Sonarr/Radarr/Prowlarr/Bazarr docs)
- LinuxServer.io container docs (PUID/PGID, paths, common env vars)
- Authelia docs (SSO/MFA patterns)
- Cloudflare Zero Trust / Tunnel docs (ingress + WAF + Access patterns)
- Popular homelab stacks to learn from: DockSTARTer, Saltbox, “YAMS”-style media servers, and IBRACORP guides

If you want, I can do a follow-up pass where I *actively* compare your compose + wizard + docs to those projects and produce a “diff-style” checklist (what you’re missing, what you’re doing better, what to copy).

---

## Quick wins checklist (copy/paste)

- [ ] Remove `./.env` and `./control-server/.env` from git history; rotate secrets
- [ ] Remove `./.DS_Store` from git
- [ ] Fix `lucide-react` star import in `docs-site/src/components/docs/appData.ts`
- [ ] Delete/move unused `docs-site` files reported by `knip` (start with unused utilities and big components)
- [ ] Remove unused deps in `docs-site` (`react-markdown`, `react-syntax-highlighter`, `@tanstack/react-query`, `@use-gesture/react`) if you confirm you don’t need them
- [ ] Add explicit `pino` dependency to `control-server` or remove/centralize logging
- [ ] Standardize scripts on Compose v2 command detection and usage
